<!DOCTYPE html>

<html lang="sr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>

<script>const API_SAVE_PROD="save_izvestaj.php";</script>
<title>PROIZVODNJA :: NEBULA OPS</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
    /* =====================
       NEBULA OPS — SCI‑FI UI
       ===================== */
    :root{
      --bg:#050713;
      --ink:#dbeafe;
      --muted:#9aa7c1;
      --glass:#0b1024cc;
      --glass-strong:#0b1024f2;
      --line:#182246;
      --neon:#7c3aed;
      --neon2:#06b6d4;
      --ok:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --grid:rgba(124,58,237,.15);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      color:var(--ink);
      background: radial-gradient(1200px 800px at 10% -10%, rgba(124,58,237,.25), transparent 55%),
                  radial-gradient(1000px 700px at 120% 10%, rgba(6,182,212,.22), transparent 50%),
                  var(--bg);
      overflow-x:hidden;
      letter-spacing:.2px;
    }
    /* STARFIELD BACKDROP */
    #stars, #scanlines{
      position:fixed; inset:0; z-index:0; pointer-events:none;
    }
    #scanlines{
      background: repeating-linear-gradient(0deg, rgba(255,255,255,.03), rgba(255,255,255,.03) 1px, transparent 2px, transparent 3px);
      mix-blend-mode: overlay; opacity:.25;
    }
    /* HOLO GRID */
    .gridlines{
      position:fixed; inset:0; z-index:0; pointer-events:none;
      background-image:
        linear-gradient(to right, var(--grid) 1px, transparent 1px),
        linear-gradient(to bottom, var(--grid) 1px, transparent 1px);
      background-size: 60px 60px, 60px 60px;
      mask-image: radial-gradient(circle at 70% 0%, black 40%, transparent 70%);
    }

    /* HEADER */
    header{
      position:sticky; top:0; z-index:40;
      backdrop-filter: blur(10px) saturate(130%);
      background:linear-gradient(90deg, rgba(124,58,237,.22), rgba(6,182,212,.18));
      border-bottom:1px solid rgba(255,255,255,.08);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .h-wrap{max-width:1280px;margin:0 auto;padding:14px 22px;display:flex;gap:14px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{font-weight:900; letter-spacing:.4px; display:flex; align-items:center; gap:10px}
    .brand .sig{font-size:12px; color:var(--muted); letter-spacing:.28em}
    .neon{background: linear-gradient(135deg, var(--neon), var(--neon2));
      -webkit-background-clip:text;background-clip:text;color:transparent}
    .tabs{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .tab{padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(11,16,36,.7);
      color:#eaf2ff;font-weight:800;cursor:pointer;letter-spacing:.3px;transition:.18s}
    .tab:hover{transform:translateY(-1px); box-shadow:0 8px 24px rgba(124,58,237,.25)}
    .tab-active{background: linear-gradient(135deg, var(--neon), var(--neon2)); color:#041017; border-color:transparent}
    .chip{background:rgba(255,255,255,.08); padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid rgba(255,255,255,.14)}

    /* LAYOUT */
    .wrap{max-width:1280px;margin:0 auto;padding:20px; position:relative; z-index:1}
    .deck{display:grid; grid-template-columns:repeat(12,1fr); gap:12px; margin-top:12px}
    .col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-5{grid-column:span 5}.col-6{grid-column:span 6}.col-7{grid-column:span 7}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
    @media (max-width:768px){
      .h-wrap{flex-direction:column;align-items:flex-start;gap:8px}
      .wrap{padding:10px}
      .deck{grid-template-columns:1fr}
      .col-3,.col-4,.col-5,.col-6,.col-7,.col-8,.col-12{grid-column:span 1}
    }

    .card{
      background: var(--glass);
      border:1px solid var(--line);
      border-radius:16px;
      padding:18px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06), 0 10px 30px rgba(0,0,0,.35);
    }
    .card.glow{ position:relative; }
    .card.glow::after{
      content:""; position:absolute; inset:-1px;
      border-radius:16px; pointer-events:none;
      background: linear-gradient(135deg, rgba(124,58,237,.35), rgba(6,182,212,.35));
      filter: blur(18px); opacity:.35;
      z-index:-1;
    }
    label{display:block;font-weight:800;margin:6px 0 6px 2px;color:#c7d2fe;font-size:12px;letter-spacing:.3px;text-transform:uppercase}
    input, select, button{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--line);
      background:#070b1a; color:var(--ink); outline:none; transition:.15s;
    }
    input:focus, select:focus{ box-shadow:0 0 0 2px rgba(6,182,212,.25), 0 0 0 5px rgba(124,58,237,.15) }
    button{ cursor:pointer; font-weight:900; letter-spacing:.4px }
    button.primary{ background:linear-gradient(135deg, var(--neon), var(--neon2)); color:#051019; border:none }
    button.secondary{ background:#070b1a; border:1px solid var(--line) }
    button.ghost{ background:transparent; border:1px dashed var(--line) }
    button.ok{ background:linear-gradient(135deg, #16a34a, #22c55e); border:none; color:#041109 }
    button.danger{ background:linear-gradient(135deg, #ef4444, #f97316); border:none; color:#130505 }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .muted{ color:var(--muted); font-size:12px }
    .hidden{ display:none !important }

    /* TABLES */
    table{ width:100%; border-collapse:separate; border-spacing:0 }
    th,td{ padding:10px 12px; border-bottom:1px solid #141a33 }
    thead th{ position:sticky; top:0; background:#0c1327; z-index:1; font-size:12px; text-transform:uppercase; letter-spacing:.6px; color:#a5b4fc }
    tbody tr:nth-child(even){ background:rgba(255,255,255,.02) }
    tbody tr:hover{ background:rgba(6,182,212,.08) }
    .right{text-align:right}
    .nowrap{white-space:nowrap}
    .table-scroll{overflow-x:auto}

    /* STATS */
    .stat{ background: var(--glass-strong); border:1px solid var(--line); border-radius:16px; padding:14px; }
    .stat h4{ margin:0 0 4px 0; color:#cbd5e1; font-size:11px; font-weight:800; text-transform:uppercase; letter-spacing:.45px }
    .big{ font-size:28px; font-weight:900; background: linear-gradient(135deg, #93c5fd, #a78bfa); -webkit-background-clip:text; background-clip:text; color:transparent }

    /* MODAL */
    .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{width:min(1000px,96vw);background:#070b1a;border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 30px 80px rgba(0,0,0,.6)}
    .pill{padding:6px 10px;border-radius:999px;background:#0e1730;border:1px solid var(--line);font-size:12px}

    /* SELECT FIX */
    select{ position:relative; z-index:10; background:#070b1a }
    .card, .deck{ overflow:visible }

    /* MICRO ANIMATIONS */
    @keyframes pulseLine{0%,100%{opacity:.35}50%{opacity:.75}}
    .pulse{animation:pulseLine 1.8s infinite}

    .flash-card{animation:flashCard 1.1s ease}
    @keyframes flashCard{
      0%{box-shadow:inset 0 1px 0 rgba(255,255,255,.12),0 0 0 0 rgba(124,58,237,.0)}
      45%{box-shadow:inset 0 1px 0 rgba(255,255,255,.18),0 0 0 12px rgba(124,58,237,.25)}
      100%{box-shadow:inset 0 1px 0 rgba(255,255,255,.06),0 10px 30px rgba(0,0,0,.35)}
    }
  
/* Autocomplete status */
#companiesStatus{ margin-left:8px }


/* === Firma autocomplete (custom dropdown) === */
.ac-wrap{position:relative}
.ac-menu{
  position:absolute; left:0; right:0; top:100%; margin-top:6px;
  background:#070b1a; border:1px solid #182246; border-radius:12px;
  box-shadow:0 18px 60px rgba(0,0,0,.6);
  max-height:340px; overflow:auto; z-index:9999; display:none;
}
.ac-item{padding:10px 12px; cursor:pointer; display:flex; gap:10px; align-items:center;}
.ac-item:hover, .ac-item.active{background:rgba(6,182,212,.12)}
.ac-title{font-weight:800}
.ac-sub{font-size:12px; color:#9aa7c1}
/* Ensure containers don't clip the menu */
.card, .grid, .deck { overflow: visible !important; }


/* === Artikal autocomplete (custom dropdown) === */
.ac2-wrap{position:relative}
#acArtikal, .ac2-menu{
  position:absolute; left:0; right:0; top:100%; margin-top:6px;
  background:#070b1a; border:1px solid #182246; border-radius:12px;
  box-shadow:0 18px 60px rgba(0,0,0,.6);
  max-height:340px; overflow:auto; z-index:9999; display:none;
}
.ac2-item{padding:10px 12px; cursor:pointer; display:flex; justify-content:space-between; gap:10px; align-items:center;}
.ac2-item:hover, .ac2-item.active{background:rgba(124,58,237,.12)}
.ac2-main{display:flex; flex-direction:column}
.ac2-title{font-weight:800}
.ac2-sub{font-size:12px; color:#9aa7c1}
.ac2-unit{font-size:12px; color:#9aa7c1; white-space:nowrap}


/* Side by side layout for M1 and M2 */
.m1m2-wrap { display:flex; gap:20px; align-items:flex-start; }
.m1m2-wrap label { display:block; }
.m1m2-wrap input { width:120px; }


/* Horizontal layout for M1 and M2 fields */
.m1m2-row { display:flex; gap:30px; align-items:flex-end; margin-top:10px; }
.m1m2-row .field { flex:1; }
.m1m2-row label { display:block; margin-bottom:4px; }
.m1m2-row input { width:100%; }


/* Artikal + M2 + M1 horizontal row */
.artikal-m-row { display:flex; flex-wrap:wrap; gap:20px; align-items:flex-end; margin-top:10px; }
.artikal-m-row .field { flex:1 1 120px; }
.artikal-m-row .artikal-field { flex-basis:100%; }
.artikal-m-row label { display:block; margin-bottom:4px; }
.artikal-m-row input { width:100%; }

</style>
<style>
/* Hamburger menu */
.hamburger { display:flex; align-items:center; justify-content:center; gap:8px; padding:10px 12px; border:1px solid rgba(255,255,255,0.18); background:transparent; color:inherit; border-radius:10px; cursor:pointer; }
.hamburger .icon { width:22px; height:2px; background:currentColor; position:relative; display:block; }
.hamburger .icon::before, .hamburger .icon::after { content:""; position:absolute; left:0; right:0; height:2px; background:currentColor; }
.hamburger .icon::before { top:-6px; }
.hamburger .icon::after { top:6px; }
.nav-drawer { position:fixed; inset:0 0 0 auto; width:320px; max-width:90vw; background:rgba(17,24,39,0.98); color:#e5e7eb; border-left:1px solid rgba(255,255,255,0.08); transform:translateX(100%); transition:transform .25s ease; z-index:9999; display:flex; flex-direction:column; }
.nav-drawer.open { transform:translateX(0); }
.nav-drawer header { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,0.08); }
.nav-drawer .list { padding:8px 0; overflow:auto; }
.nav-drawer .list a { display:flex; align-items:center; gap:10px; padding:10px 16px; color:inherit; text-decoration:none; border-bottom:1px solid rgba(255,255,255,0.06); }
.nav-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.4); backdrop-filter: blur(2px); opacity:0; pointer-events:none; transition:opacity .2s ease; z-index:9998; }
.nav-backdrop.show { opacity:1; pointer-events:auto; }
@media(min-width:900px){ .hamburger{ display:inline-flex; } }
</style>
<style>
.dz-wrap{ position:relative; display:block; }
#dzMenu{ position:absolute; left:0; right:0; top:100%; margin-top:6px; background:#0b1024; border:1px solid #1d2a5a; border-radius:10px; box-shadow:0 12px 40px rgba(0,0,0,.45); max-height:320px; overflow:auto; z-index:9999; display:none;}
.dz-item{ padding:10px 12px; cursor:pointer; }
.dz-item:hover, .dz-item.active{ background:rgba(6,182,212,.12); }
.dz-title{ font-weight:700; }
.dz-sub{ font-size:12px; opacity:.8; }
.dz-input{ width:100%; }
</style>


<style>#brojZahteva{display:none !important;}</style>
</head>
<body>
<!-- immersive background -->
<canvas id="stars"></canvas>
<div id="scanlines"></div>
<div class="gridlines"></div>
<header>
<div class="h-wrap">
<div class="brand">
<span class="neon">NEBULA OPS</span>
<span class="sig">PROIZVODNJA • HOLO‑CONSOLE</span>
</div>
<div class="tabs">
<button class="tab tab-active" id="tabUnos">🛠 NOVI IZVEŠTAJ</button>
<button class="tab" id="tabPregled">📚 PREGLED</button>
<span class="chip">Poslednji broj: <b id="navLastNo">0000</b></span>
</div>
</div>
<button class="hamburger" id="hamburgerBtn"><span class="icon"></span><span>Meni</span></button></header>
<main class="wrap">
<div class="card">
<div id="unosHeader"><h1 style="margin:0 0 12px 0;">Unos izveštaja o dnevnoj proizvodnji</h1>
<p style="margin-top:0; color:#9aa3b2; font-size:14px;">Podaci se čuvaju u memoriji sajta (localStorage) i mogu se izvesti kao CSV/JSON.</p></div>
<div id="sekcija-unos">
<form id="form-izvestaj">
<div class="row">
<div>
<label for="datum">Datum</label>
<input id="datum" name="datum" required="" type="date"/>
</div>
<div>
<label for="brojZahteva">Broj zahteva (iz indexa)</label>
<select id="brojZahteva" name="brojZahteva">
<option value="">-- izaberi ili unesi --</option>
</select>
<div class="dz-wrap"><input type="text" id="brojZahtevaManual" class="dz-input" placeholder="Unesi broj zahteva"><div id="dzMenu"></div></div>
</div>
</div>
<div class="row">
<div>
<div class="artikal-m-row">
  <div class="field artikal-field">
    <label for="artikal">Artikal (iz Excela)</label>
    <div class="ac2-wrap">
      <input type="text" id="artikal" name="artikal" placeholder="Počni da kucaš...">
      <div id="acArtikal" class="ac2-menu"></div>
    </div>
  </div>
  <div class="field">
    <label for="m2">Proizvedeno (M²)</label>
    <input type="number" step="any" id="m2" name="m2" placeholder="npr. 123.45">
  </div>
  <div class="field">
    <label for="m1">Proizvedeno (M¹)</label>
    <input type="number" step="any" id="m1" name="m1" placeholder="npr. 123.45">
  </div>
  <div class="field">
    <label for="m3">Proizvedeno (M³)</label>
    <input type="number" step="any" id="m3" name="m3" placeholder="npr. 123.45">
  </div>
  <div class="field">
    <label for="kom">Proizvedeno (kom)</label>
    <input type="number" step="any" id="kom" name="kom" placeholder="npr. 123">
  </div>
</div></div></div></div>
</div>
<div>


</div>
</div>
<div id="unosActions" style="margin-top:12px; display:flex; gap:8px;">
<button type="submit">Sačuvaj izveštaj</button>
<button class="secondary" id="resetBtn" type="button">Resetuj formu</button>
</div>
</form>

<div class="card" id="lastCard" style="margin-top:20px;">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
    <h2 style="margin:0;">Poslednji uneti izveštaj</h2>
  </div>
  <div class="table-scroll">
    <table id="lastTable">
      <thead>
        <tr>
          <th>Datum</th>
          <th>Broj zahteva</th>
          <th>Artikal</th>
          <th>M¹</th>
          <th>M²</th>
          <th>M³</th>
          <th>Kom</th>
          <th class="actions">Akcije</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

</div><!-- end sekcija-unos -->
</div>
<div class="hidden" id="sekcija-pregled" style="margin-top:16px;">
<div class="card glow" id="planSummaryCard" style="margin-top:20px;">
  <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;">
    <div>
      <h2 style="margin:0;">Plan vs realizacija</h2>
      <div class="muted" id="planSummaryInfo">Rezime nije učitan</div>
    </div>
    <div class="row" style="gap:12px; flex-wrap:wrap;">
      <div style="min-width:160px;">
        <label for="filterZahtev">Broj zahteva</label>
        <input type="text" id="filterZahtev" placeholder="npr. 123"/>
      </div>
      <div style="min-width:200px;">
        <label for="filterArtikal">Artikal</label>
        <input type="text" id="filterArtikal" placeholder="Šifra ili naziv"/>
      </div>
      <div style="min-width:180px;">
        <label for="filterDatum">Datum proizvodnje</label>
        <input type="date" id="filterDatum"/>
      </div>
    </div>
  </div>
  <div class="table-scroll" style="margin-top:12px;">
    <table id="planTabela">
      <thead>
        <tr>
          <th>Broj zahteva</th>
          <th>Artikal</th>
          <th class="right">Plan</th>
          <th class="right">Proizvedeno</th>
          <th class="right">Razlika</th>
          <th>Napomena</th>
          <th class="right nowrap">Akcije</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
<div class="card" style="margin-top:20px;">
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
<h2 style="margin:0;">Sačuvani izveštaji</h2>

<div>
<button id="exportCsv">Izvezi CSV</button>
<button class="secondary" id="exportJson">Izvezi JSON</button>
</div>
</div>
<div class="table-scroll">
<table id="tabela">
<thead>
<tr>
<th>Datum</th>
<th>Broj zahteva</th>
<th>Artikal</th>
<th>m¹</th><th>M²</th><th>M³</th><th>Kom</th>
<th>Napomena</th><th class="right nowrap">Akcije</th></tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
</div><!-- end sekcija-pregled -->
<!-- DETALJNI PRIKAZ IZVEŠTAJA -->
<div class="modal-back" id="modalBackPregled" style="display:none">
  <div class="modal">
    <div class="row" style="justify-content:space-between">
      <div class="row" style="gap:8px">
        <span class="pill">Detalji plana i proizvodnje</span>
        <span class="chip" id="detChip"></span>
      </div>
      <button class="secondary" id="closePregled" style="width:auto">Zatvori</button>
    </div>
    <div class="row" style="margin-top:12px; gap:12px; flex-wrap:wrap;">
      <div class="stat" style="flex:1 1 160px;">
        <h4>Plan</h4>
        <div class="big" id="detPlan">—</div>
        <div class="muted" id="detPlanLabel"></div>
      </div>
      <div class="stat" style="flex:1 1 160px;">
        <h4>Proizvedeno</h4>
        <div class="big" id="detProizvedeno">—</div>
        <div class="muted" id="detProizvedenoLabel"></div>
      </div>
      <div class="stat" style="flex:1 1 160px;">
        <h4>Razlika</h4>
        <div class="big" id="detRazlika">—</div>
        <div class="muted" id="detRazlikaLabel"></div>
      </div>
    </div>
    <div class="muted" id="detNapomena" style="margin-top:8px"></div>
    <div class="table-scroll" style="margin-top:12px">
      <table id="detPregled">
        <thead>
          <tr>
            <th>Datum</th>
            <th>Broj zahteva</th>
            <th>Artikal</th>
            <th class="right">M¹</th>
            <th class="right">M²</th>
            <th class="right">M³</th>
            <th class="right">Kom</th>
            <th>Napomena</th>
            <th class="right nowrap">Akcije</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>
</main>
<script>
const ARTIKLI = ["BL-3CM-40x40", "GR-2CM-100x50", "MR-5CM-20x20", "PL-2CM-60x30", "ST-STD-120x30"];

// ——— Storage helpers ———
const STORAGE_KEY = 'izvestajiProizvodnje';
const ZAH_TE_KEY = 'proizvodnja_nalozi_v1'; // očekujemo da index.html čuva zahteve ovde

function loadReports() { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
function saveReports(list) { localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }

function loadZahteviOptions() { 
  const raw = localStorage.getItem(ZAH_TE_KEY);
  const sel = document.getElementById('brojZahteva');
  sel.innerHTML = '<option value="">-- izaberi ili unesi --</option>';
  if (!raw) return;
  try {
    const arr = JSON.parse(raw);
    const list = Array.isArray(arr) ? arr : [];
    const values = Array.from(new Set(list.map(o => (o && o.broj) ? String(o.broj) : null).filter(Boolean))).sort();
    values.forEach(v => {
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      sel.appendChild(opt);
    });
  } catch(e) {}
}

      const entry = Object.entries(obj).find(([k,v]) => ['string','number'].includes(typeof v));
      return entry ? entry[0] : null;
    };
    let key = null;
    if (list.length) key = guessKey(list[0]);
    const values = new Set();
    for (const it of list) {
      const v = key ? it[key] : null;
      if (v != null && v !== '') values.add(String(v));
    }
    [...values].sort().forEach(v => {
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      sel.appendChild(opt);
    });
  } catch(e) {}
}

function populateArtikli() {
  const dl = document.getElementById('artikli');
  dl.innerHTML = '';
  (ARTIKLI || []).forEach(a => {
    const opt = document.createElement('option');
    opt.value = a;
    dl.appendChild(opt);
  });
}

// Render tabela
function renderTable() {
  const tbody = document.querySelector('#lastTable tbody');
  tbody.innerHTML = '';
  const data = loadReports();
  data.forEach((row, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = ''
      + '<td>' + (row.datum || '') + '</td>'
      + '<td>' + (row.brojZahteva || '') + '</td>'
      + '<td>' + (row.artikal || '') + '</td>'
      + '<td>' + (row.m1 != null ? Number(row.m1).toFixed(2) : '') + '</td>'
      + '<td>' + (row.m2 != null ? Number(row.m2).toFixed(2) : '') + '</td>'
      + '<td>' + (row.m3 != null ? Number(row.m3).toFixed(2) : '') + '</td>'
      + '<td>' + (row.kom != null ? Number(row.kom).toFixed(2) : '') + '</td>'
      + '<td class="actions">'
      +   '<button data-action="edit" data-i="' + idx + '">Izmeni</button> '
      +   '<button data-action="del" data-i="' + idx + '" class="secondary">Obriši</button>'
      + '</td>';
    tbody.appendChild(tr);
  });
}


function resetForm() {
  document.getElementById('form-izvestaj').reset();
  document.getElementById('datum').valueAsDate = new Date();
}

function exportCSV() {
  const rows = loadReports();
  const headers = ['datum','brojZahteva','artikal','m1','m2','m3','kom'];
  const csv = [headers.join(',')]
    .concat(rows.map(r => headers.map(h => {
      const v = (r[h] ?? '').toString().replaceAll('"','""');
      return '"' + v + '"';
    }).join(',')))
    .join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'izvestaji_proizvodnje.csv';
  a.click();
}

function exportJSON() {
  const rows = loadReports();
  const blob = new Blob([JSON.stringify(rows, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'izvestaji_proizvodnje.json';
  a.click();
}

// Submit handler
document.getElementById('form-izvestaj').addEventListener('submit', (e) => {
  e.preventDefault();
  const datum = document.getElementById('datum').value;
  const selectVal = document.getElementById('brojZahteva').value;
  const manualVal = document.getElementById('brojZahtevaManual').value.trim();
  const brojZahteva = manualVal || selectVal;
  const artikal = document.getElementById('artikal').value.trim();
  const m1 = parseFloat(document.getElementById('m1').value);
  const m2 = parseFloat(document.getElementById('m2').value);
  const m3 = parseFloat(document.getElementById('m3').value);
  const kom = parseFloat(document.getElementById('kom').value);
  if (!datum || !brojZahteva || !artikal || isNaN(m1)) {
    alert('Popunite sva polja.');
    return;
  }
  const rows = loadReports();
  rows.push({ datum, brojZahteva, artikal, m1: isNaN(m1) ? null : m1, m2: isNaN(m2) ? null : m2, m3: isNaN(m3) ? null : m3, kom: isNaN(kom) ? null : kom });
  saveReports(rows);
  renderTable();
  resetForm();
});

// Edit/Delete actions
document.querySelector('#tabela').addEventListener('click', (e) => {
  const btn = e.target.closest('button');
  if (!btn) return;
  const idx = parseInt(btn.getAttribute('data-i'));
  const rows = loadReports();
  if (btn.getAttribute('data-action') === 'del') {
    if (confirm('Obrisati stavku?')) {
      rows.splice(idx, 1);
      saveReports(rows);
      renderTable();
    }
  } else if (btn.getAttribute('data-action') === 'edit') {
    const r = rows[idx];
    document.getElementById('datum').value = r.datum || '';
    const sel = document.getElementById('brojZahteva');
    const opt = Array.from(sel.options).find(o => o.value === r.brojZahteva);
    if (opt) { sel.value = r.brojZahteva; document.getElementById('brojZahtevaManual').value=''; }
    else { sel.value=''; document.getElementById('brojZahtevaManual').value = r.brojZahteva || ''; }
    document.getElementById('artikal').value = r.artikal || '';
    document.getElementById('m1').value = r.m1 != null ? r.m1 : '';
    document.getElementById('m2').value = r.m2 != null ? r.m2 : '';
    document.getElementById('m3').value = r.m3 != null ? r.m3 : '';
    document.getElementById('kom').value = r.kom != null ? r.kom : '';
    rows.splice(idx, 1);
    saveReports(rows);
    renderTable();
  }
});

document.getElementById('resetBtn').addEventListener('click', resetForm);
document.getElementById('exportCsv').addEventListener('click', exportCSV);
document.getElementById('exportJson').addEventListener('click', exportJSON);

populateArtikli();
loadZahteviOptions();
renderTable();
resetForm();
</script>
<aside class="nav-drawer" id="navDrawer"><header><div>Navigacija</div><button class="hamburger" id="closeDrawer"><span class="icon"></span><span>Zatvori</span></button></header><nav class="list" id="navList"></nav></aside><div class="nav-backdrop" id="navBackdrop"></div><script>
// Manifest ugradjen u HTML (nema eksternog fajla)
window.APP_PAGES = [
  { href: "index.html", label: "Unos zahteva" },
  { href: "dnevna-proizvodnja.html", label: "Dnevna proizvodnja" }
];
</script><script>
(function(){
  const open = ()=>{ document.getElementById('navDrawer').classList.add('open'); document.getElementById('navBackdrop').classList.add('show'); };
  const close = ()=>{ document.getElementById('navDrawer').classList.remove('open'); document.getElementById('navBackdrop').classList.remove('show'); };
  document.getElementById('hamburgerBtn').addEventListener('click', open);
  document.getElementById('closeDrawer').addEventListener('click', close);
  document.getElementById('navBackdrop').addEventListener('click', close);

  function niceLabel(href){
    try {
      if (href.endsWith('index.html')) return 'Unos zahteva';
      if (href.includes('dnevna-proizvodnja')) return 'Dnevna proizvodnja';
      return href.replace(/\/.html?$/,'').replace(/[-_]/g,' ').replace(/^\/+/, '')
                 .replace(/\.html$/,'')
                 .replace(/\b\w/g, s=>s.toUpperCase());
    } catch(e){ return href; }
  }

  function render(list){
    const nav = document.getElementById('navList');
    nav.innerHTML='';
    const seen = new Set();
    list.forEach(it=>{
      const href = (typeof it === 'string') ? it : (it.href || '');
      if(!href || seen.has(href)) return;
      seen.add(href);
      const label = (typeof it === 'string') ? niceLabel(href) : (it.label || niceLabel(href));
      const a = document.createElement('a');
      a.href = href;
      a.textContent = label;
      nav.appendChild(a);
    });
  }

  const fallback = [
    { href: 'index.html', label: 'Unos zahteva' },
    { href: 'dnevna-proizvodnja.html', label: 'Dnevna proizvodnja' },
  ];

  function init(){
    if (window.APP_PAGES && Array.isArray(window.APP_PAGES) && window.APP_PAGES.length){
      render(window.APP_PAGES);
    } else {
      render(fallback);
    }
  }
  init();
})();</script>
<script>
(function(){
  const CSV_URL = 'data/zahtevi.csv';
  let ZAH = [];
  const input = document.getElementById('brojZahtevaManual');
  const menu  = document.getElementById('dzMenu');
  if(!input || !menu) return;
  input.removeAttribute('readonly'); input.disabled = false;
  function norm(s){ return (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/đ/g,'d').replace(/ž/g,'z').replace(/č/g,'c').replace(/ć/g,'c').replace(/š/g,'s'); }
  async function loadCSVOnce(){
    if(ZAH.length) return ZAH;
    try{
      const res = await fetch(CSV_URL, {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const text = await res.text();
      const lines = text.replace(/^\uFEFF/, '').split(/\r?\n/).filter(l=>l.trim().length);
      if(lines.length<2) return ZAH;
      const header = lines[0].split(';').map(h=>norm(h.trim()));
      const iB = header.indexOf('broj'), iF = header.indexOf('firma'), iA = header.indexOf('adresa');
      for(let i=1;i<lines.length;i++){
        const cols = lines[i].split(';');
        const b=(cols[iB]||'').replace(/^"|"$/g,'');
        const f=(cols[iF]||'').replace(/^"|"$/g,'');
        const a=(cols[iA]||'').replace(/^"|"$/g,'');
        if(b) ZAH.push({broj:b, firma:f, adresa:a});
      }
    }catch(e){ console.warn('CSV load error', e); }
    return ZAH;
  }
  let items=[], idx=-1;
  function hide(){ menu.style.display='none'; menu.innerHTML=''; items=[]; idx=-1; }
  function show(list){
    menu.innerHTML='';
    items = list.slice(0,30);
    items.forEach((it,i)=>{
      const d=document.createElement('div'); d.className='dz-item'+(i===0?' active':'');
      if(i===0) idx=0;
      const t=document.createElement('div'); t.className='dz-title'; t.textContent = `${it.broj} / ${it.firma||''} / ${it.adresa||''}`;
      const s=document.createElement('div'); s.className='dz-sub'; s.textContent='iz CSV baze zahteva';
      d.appendChild(t); d.appendChild(s);
      d.addEventListener('click', ()=>choose(i));
      menu.appendChild(d);
    });
    menu.style.display = items.length ? 'block' : 'none';
  }
  function choose(i){ const it = items[i]; if(!it) return; input.value = it.broj; hide(); input.dispatchEvent(new Event('change', {bubbles:true})); }
  function updateList(q){
    const n = norm(q||''); if(!n){ hide(); return; }
    const list = ZAH.filter(z => norm(`${z.broj} / ${z.firma||''} / ${z.adresa||''}`).includes(n));
    list.length ? show(list) : hide();
  }
  input.setAttribute('autocomplete','off');
  input.addEventListener('input', async e=>{ await loadCSVOnce(); updateList(e.target.value); });
  input.addEventListener('focus', async e=>{ await loadCSVOnce(); updateList(e.target.value); });
  document.addEventListener('click', e=>{ if(e.target!==input && !menu.contains(e.target)) hide(); });
  input.addEventListener('keydown', e=>{
    if(menu.style.display!=='block') return;
    const nodes=[...menu.querySelectorAll('.dz-item')]; if(!nodes.length) return;
    if(e.key==='ArrowDown'){ e.preventDefault(); idx=(idx+1)%nodes.length; nodes.forEach((n,i)=>n.classList.toggle('active', i===idx)); }
    if(e.key==='ArrowUp'){ e.preventDefault(); idx=(idx-1+nodes.length)%nodes.length; nodes.forEach((n,i)=>n.classList.toggle('active', i===idx)); }
    if(e.key==='Enter'){ e.preventDefault(); if(idx>=0) choose(idx); }
    if(e.key==='Escape'){ hide(); }
  });
})();
</script>

<script>
// === Artikal: autocomplete (identično indexu) — with embedded fallback ===
(function(){ 
  const EXCEL_FILE = 'artikli.xlsx';
  let ARTIKLI = [];
  const EMBED = [{"sifra": "PL-2CM-60x30", "dimenzije": "001x000x000", "jedinica": "m2"}, {"sifra": "ST-STD-120x30", "dimenzije": "001x000x000", "jedinica": "kom"}, {"sifra": "BL-3CM-40x40", "dimenzije": "000x000x000", "jedinica": "m2"}, {"sifra": "GR-2CM-100x50", "dimenzije": "001x001x000", "jedinica": "m2"}, {"sifra": "MR-5CM-20x20", "dimenzije": "000x000x000", "jedinica": "kom"}, {"sifra": "30xslobodno", "dimenzije": "001x000x000", "jedinica": "nan"}];

  async function parseWorkbook(ab){ 
    const wb = XLSX.read(ab, { type:'array' });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const data = XLSX.utils.sheet_to_json(ws, { defval: '' });
    ARTIKLI = data.map(r => ({ 
      sifra: r.sifra || r.Sifra || r.SIFRA,
      dimenzije: r.dimenzije || r.Dimenzije || '',
      jedinica: r.jedinica || r.JM || r.jm || r.Jedinica || ''
    })).filter(a=>a.sifra);
  }
  async function loadExcel(){ 
    try{ 
      const res = await fetch(EXCEL_FILE, {cache:'no-store'});
      if(!res.ok) throw new Error();
      const ab = await res.arrayBuffer();
      await parseWorkbook(ab);
    }catch(e){ ARTIKLI = Array.isArray(EMBED) ? EMBED : []; }
  }
  function norm(s){ return (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/đ/g,'d').replace(/ž/g,'z').replace(/č/g,'c').replace(/ć/g,'c').replace(/š/g,'s'); }

  function setupArtikalAC(inp){
    const wrap = inp && inp.closest('.ac2-wrap');
    const menu = wrap && wrap.querySelector('.ac2-menu');
    if(!inp || !menu) return;

    let items=[], idx=-1;
    function hide(){ menu.style.display='none'; menu.innerHTML=''; items=[]; idx=-1; }
    function choose(i){
      const a = items[i]; if(!a) return;
      inp.value = `${a.sifra} – ${a.dimenzije||''} ${a.jedinica?`(${a.jedinica})`:''}`.trim();
      hide();
      if(inp.id==='artikal') document.getElementById('m1')?.focus();
      if(inp.id==='editArtikal') document.getElementById('editM1')?.focus();
    }
    function show(list){
      menu.innerHTML='';
      items = list.slice(0,30);
      items.forEach((a,i)=>{
        const d=document.createElement('div'); d.className='ac2-item'+(i===0?' active':'');
        if(i===0) idx=0;
        const main=document.createElement('div'); main.className='ac2-main';
        const t=document.createElement('div'); t.className='ac2-title'; t.textContent=a.sifra||'';
        const s=document.createElement('div'); s.className='ac2-sub'; s.textContent=a.dimenzije||'';
        main.appendChild(t); main.appendChild(s);
        const u=document.createElement('div'); u.className='ac2-unit'; u.textContent=a.jedinica||'';
        d.appendChild(main); d.appendChild(u);
        d.addEventListener('click', ()=>choose(i));
        menu.appendChild(d);
      });
      menu.style.display = items.length ? 'block' : 'none';
    }
    function update(q){
      const n=norm(q||''); if(!n){ hide(); return; }
      const list=(ARTIKLI||[]).filter(a=> norm(`${a.sifra||''} ${a.dimenzije||''} ${a.jedinica||''}`).includes(n));
      list.length ? show(list) : hide();
    }
    inp.setAttribute('autocomplete','off');
    inp.addEventListener('input', e=> update(e.target.value));
    inp.addEventListener('focus', e=> update(e.target.value));
    document.addEventListener('click', e=>{ if(e.target!==inp && !wrap.contains(e.target)) hide(); });
    inp.addEventListener('keydown', e=>{
      if(menu.style.display!=='block') return;
      const nodes=[...menu.querySelectorAll('.ac2-item')]; if(!nodes.length) return;
      if(e.key==='ArrowDown'){ e.preventDefault(); idx=(idx+1)%nodes.length; nodes.forEach((n,i)=>n.classList.toggle('active', i===idx)); }
      if(e.key==='ArrowUp'){ e.preventDefault(); idx=(idx-1+nodes.length)%nodes.length; nodes.forEach((n,i)=>n.classList.toggle('active', i===idx)); }
      if(e.key==='Enter'){ e.preventDefault(); if(idx>=0) choose(idx); }
      if(e.key==='Escape'){ hide(); }
    });

    // Auto-open if already has value
    if(inp.value) update(inp.value);
  }

  document.addEventListener('DOMContentLoaded', async () => {
    await loadExcel();
    const mainInp = document.getElementById('artikal');
    if(mainInp) setupArtikalAC(mainInp);
    const editInp = document.getElementById('editArtikal');
    if(editInp) setupArtikalAC(editInp);
  });
})();
// === END Artikal
</script>

<script>
document.addEventListener("DOMContentLoaded", function(){
  var d = document.getElementById('datum');
  if(d && !d.value){
    var t = new Date();
    var yyyy = t.getFullYear();
    var mm = String(t.getMonth()+1).padStart(2,'0');
    var dd = String(t.getDate()).padStart(2,'0');
    d.value = yyyy + "-" + mm + "-" + dd;
  }
});
</script>


<!-- DUAL SUBMIT FALLBACK -->
<iframe name="serverSink" id="serverSink" style="display:none;"></iframe>
<form id="serverMirrorForm" action="save_izvestaj.php" method="post" target="serverSink" style="display:none;">
  <input type="hidden" name="datum" />
  <input type="hidden" name="brojZahteva" />
  <input type="hidden" name="artikal" />
  <input type="hidden" name="m1" />
  <input type="hidden" name="m2" />
  <input type="hidden" name="m3" />
  <input type="hidden" name="kom" />
  <input type="hidden" name="napomena" />
</form>
<script>
(function(){
  // Attach once
  const form = document.getElementById('form-izvestaj');
  if(!form) return;
  if(form.__dualSubmitAttached) return; form.__dualSubmitAttached = true;

  form.addEventListener('submit', function(e){
    // Populate and submit the hidden mirror form (server POST via iframe)
    try{
      const F = document.getElementById('serverMirrorForm');
      if(F){
        F.elements['datum'].value = document.getElementById('datum')?.value || '';
        const sel = document.getElementById('brojZahteva')?.value || '';
        const man = document.getElementById('brojZahtevaManual')?.value.trim() || '';
        F.elements['brojZahteva'].value = man || sel;
        F.elements['artikal'].value = document.getElementById('artikal')?.value || '';
        F.elements['m1'].value = document.getElementById('m1')?.value || '';
        F.elements['m2'].value = document.getElementById('m2')?.value || '';
        F.elements['m3'].value = document.getElementById('m3')?.value || '';
        F.elements['kom'].value = document.getElementById('kom')?.value || '';
        const nEl = document.getElementById('napomena');
        F.elements['napomena'].value = nEl ? (nEl.value||'').trim() : '';
        F.submit();
      }
    }catch(err){ console.warn('mirror submit error', err); }
  }, true);
})();
</script>


<script>
(function(){
  const CSV_URL = 'data/proizvodnja.csv';
  async function updateLastSaved(){
    try{
      const res = await fetch(CSV_URL, {cache:'no-store'});
      if(!res.ok){ return; }
      const text = await res.text();
      const lines = text.replace(/^\uFEFF/, '').split(/\r?\n/).filter(l=>l.trim().length);
      if(lines.length < 2){ return; } // no data rows
      const header = lines[0].split(';').map(s=>s.replace(/^"|"$/g,''));
      const last = lines[lines.length-1].split(';').map(s=>s.replace(/^"|"$/g,''));
      const obj = {}; header.forEach((h,i)=>obj[h]=last[i]||'');
      const show = [
        obj.datum ? ('Datum: '+obj.datum) : null,
        obj.brojZahteva ? ('Broj: '+obj.brojZahteva) : null,
        obj.artikal ? ('Artikal: '+obj.artikal) : null,
        (obj.m1 && !isNaN(obj.m1)) ? ('M¹: '+obj.m1) : null,
        (obj.m2 && !isNaN(obj.m2)) ? ('M²: '+obj.m2) : null,
        (obj.m3 && !isNaN(obj.m3)) ? ('M³: '+obj.m3) : null,
        (obj.kom && !isNaN(obj.kom)) ? ('Kom: '+obj.kom) : null,
        obj.napomena ? ('Napomena: '+obj.napomena) : null
      ].filter(Boolean).join(' • ');
      const el = document.getElementById('lastSaved');
      if(el) el.textContent = show || '—';
    }catch(e){ /* silent */ }
  }
  // Trigger after server POST completes (iframe load)
  const sink = document.getElementById('serverSink');
  if(sink){
    sink.addEventListener('load', updateLastSaved);
  }
  // Also run on load (to show current last)
  document.addEventListener('DOMContentLoaded', updateLastSaved);
  window.updateLastSaved = updateLastSaved;
})();
</script>


<script>
(function(){
  const CSV_URL = 'data/proizvodnja.csv';
  async function updateLastSaved(){
    try{
      const res = await fetch(CSV_URL, {cache:'no-store'});
      if(!res.ok){ return; }
      const text = await res.text();
      const lines = text.replace(/^\uFEFF/, '').split(/\r?\n/).filter(l=>l.trim().length);
      if(lines.length < 2){ return; } // no data rows
      const header = lines[0].split(';').map(s=>s.replace(/^"|"$/g,''));
      const last = lines[lines.length-1].split(';').map(s=>s.replace(/^"|"$/g,''));
      const obj = {}; header.forEach((h,i)=>obj[h]=last[i]||'');
      // format numbers
      const fmt = v => (v && !isNaN(v)) ? parseFloat(v).toFixed(2) : v;
      const rowHtml = `<tr>
        <td>${obj.datum||''}</td>
        <td>${obj.brojZahteva||''}</td>
        <td>${obj.artikal||''}</td>
        <td>${fmt(obj.m1)||''}</td>
        <td>${fmt(obj.m2)||''}</td>
        <td>${fmt(obj.m3)||''}</td>
        <td>${fmt(obj.kom)||''}</td>
        <td></td>
      </tr>`;
      const tbody = document.querySelector('#lastTable tbody');
      if(tbody){ tbody.innerHTML = rowHtml; }
    }catch(e){ console.error('updateLastSaved', e); }
  }
  const sink = document.getElementById('serverSink');
  if(sink){ sink.addEventListener('load', updateLastSaved); }
  document.addEventListener('DOMContentLoaded', updateLastSaved);
  window.updateLastSaved = updateLastSaved;
})();
</script>


<script>
(function(){
  const sink = document.getElementById('serverSink');
  if(!sink || sink.__refreshPregledAttached) return;
  sink.__refreshPregledAttached = true;
  sink.addEventListener('load', async () => {
    try{
      if(typeof window.renderPregled === 'function'){
        const r = window.renderPregled();
        if(r && typeof r.then === 'function') await r;
      }else if(typeof window.refreshPlanPregled === 'function'){
        const focus = !document.getElementById('sekcija-pregled')?.classList.contains('hidden');
        const r = window.refreshPlanPregled({focus});
        if(r && typeof r.then === 'function') await r;
      }else if(typeof window.renderPregledCSV === 'function'){
        const r = window.renderPregledCSV();
        if(r && typeof r.then === 'function'){
          const rows = await r;
          if(typeof window.onPregledRendered === 'function') window.onPregledRendered(rows, {});
        }
      }else{
        window.location.reload();
      }
    }catch(err){
      console.warn('Greška pri osvežavanju pregleda proizvodnje', err);
    }
  });
})();
</script>


<script>
(function(){
  const q = s => document.querySelector(s);
  function setTab(which){
  const actions = document.getElementById("unosActions");
    const header = document.getElementById("unosHeader");
    q('#sekcija-unos')?.classList.toggle('hidden', which!=='unos'); if(actions) actions.style.display = (which==='unos') ? 'flex' : 'none'; if(header) header.style.display = (which==='unos') ? '' : 'none';
    q('#sekcija-pregled')?.classList.toggle('hidden', which!=='pregled');
    q('#tabUnos')?.classList.toggle('tab-active', which==='unos');
    q('#tabPregled')?.classList.toggle('tab-active', which==='pregled');
    if(which==='unos'){ loadLastFromCSV(); }
    if(which==='pregled'){ refreshPlanPregled({focus:true}); }
  }
  q('#tabUnos')?.addEventListener('click', ()=>setTab('unos'));
  q('#tabPregled')?.addEventListener('click', ()=>setTab('pregled'));
  window.__setTab = setTab;
  setTab('unos');
})();

async function loadLastFromCSV(){
  try{
    const res = await fetch('data/proizvodnja.csv', {cache:'no-store'});
    if(!res.ok) return;
    const text = await res.text();
    const lines = text.replace(/^\uFEFF/, '').split(/\r?\n/).filter(l=>l.trim().length);
    if(lines.length < 2) return;
    const header = lines[0].split(';').map(s=>s.replace(/^"|"$/g,''));
    const last = lines[lines.length-1].split(';').map(s=>s.replace(/^"|"$/g,''));
    const idx = (name)=> header.indexOf(name);
    const fmt = v => (v && !isNaN(v)) ? Number(v).toFixed(2) : v;
    const tbody = document.querySelector('#lastTable tbody');
    if(!tbody) return;
    const rowHtml = '<tr>'
      + '<td>'+(last[idx('datum')]||'')+'</td>'
      + '<td>'+(last[idx('brojZahteva')]||'')+'</td>'
      + '<td>'+(last[idx('artikal')]||'')+'</td>'
      + '<td>'+(fmt(last[idx('m1')])||'')+'</td>'
      + '<td>'+(fmt(last[idx('m2')])||'')+'</td>'
      + '<td>'+(fmt(last[idx('m3')])||'')+'</td>'
      + '<td>'+(fmt(last[idx('kom')])||'')+'</td>'
      + '<td></td>'
      + '</tr>';
    tbody.innerHTML = rowHtml;
  }catch(e){}
}
document.addEventListener('DOMContentLoaded', loadLastFromCSV);

async function fetchCSVAll(){
  const res = await fetch('data/proizvodnja.csv', {cache:'no-store'});
  if(!res.ok) return [];
  const text = await res.text();
  const lines = text.replace(/^\uFEFF/, '').split(/\r?\n/).filter(l=>l.trim().length);
  if(lines.length<2) return [];
  const header = lines[0].split(';').map(s=>s.replace(/^"|"$/g,''));
  const rows = [];
  for(let i=1;i<lines.length;i++){
    const cols = lines[i].split(';').map(s=>s.replace(/^"|"$/g,''));
    const modern = cols.length >= 8 || header.length >= 8;
    rows.push({
      datum: cols[0]||'',
      brojZahteva: cols[1]||'',
      artikal: cols[2]||'',
      m1: cols[3]||'',
      m2: cols[4]||'',
      m3: cols[5]||'',
      kom: modern ? cols[6]||'' : '',
      napomena: modern ? cols[7]||'' : cols[6]||''
    });
  }
  return rows;
}
const KEY_SEP = '|||';
function norm(s){ return (s||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
function fmt(v){ return (v && !isNaN(v)) ? Number(v).toFixed(2) : v; }
function toNumber(value){
  if(value===null || value===undefined) return 0;
  if(typeof value==='number'){ return Number.isFinite(value) ? value : 0; }
  const str = String(value).trim();
  if(!str) return 0;
  const normalized = str.replace(/\s+/g,'').replace(',', '.');
  const num = Number(normalized);
  return Number.isFinite(num) ? num : 0;
}
function canonicalUnit(unit){
  const u = (unit||'').toString().trim().toLowerCase();
  if(!u) return 'm2';
  if(u==='m2' || u==='m²') return 'm2';
  if(u==='m1' || u==='m¹') return 'm1';
  if(u==='m3' || u==='m³') return 'm3';
  if(u==='kom' || u==='komada' || u==='komad' || u==='pcs') return 'kom';
  return u;
}
function unitLabel(unit){
  switch(unit){
    case 'm1': return 'M¹';
    case 'm2': return 'M²';
    case 'm3': return 'M³';
    case 'kom': return 'Kom';
    default: return (unit||'').toUpperCase();
  }
}
function decimalsForUnit(unit){
  switch(unit){
    case 'kom': return 0;
    case 'm3': return 3;
    default: return 2;
  }
}
function formatQty(value, unit){
  let num = Number(value);
  if(!Number.isFinite(num)) num = 0;
  const dec = decimalsForUnit(unit);
  const fixed = num.toFixed(dec);
  return fixed.replace(/^-0+(\.0+)?$/, '0$1');
}
function formatQtyWithUnit(value, unit){
  const label = unitLabel(unit);
  const qty = formatQty(value, unit);
  return label ? `${qty} ${label}` : qty;
}
function normalizeRequestNumber(v){
  const trimmed = (v||'').toString().trim();
  if(!trimmed) return '';
  const upper = trimmed.toUpperCase();
  const cleaned = upper.replace(/^0+(?=\d)/,'');
  return cleaned || '0';
}
function normalizeArticleKey(v){
  return (v||'').toString().trim().toLowerCase();
}
function parseCSVFlexible(text){
  text = text.replace(/^\uFEFF/, '');
  const first = text.split(/\r?\n/,1)[0] || '';
  const delim = first.includes(';') ? ';' : ',';
  const rows = [];
  let i=0, field='', row=[], inQuotes=false;
  while(i<text.length){
    const ch = text[i];
    if(ch==='"'){
      if(inQuotes && text[i+1]==='"'){ field+='"'; i+=2; continue; }
      inQuotes = !inQuotes; i++; continue;
    }
    if(!inQuotes && (ch==='\n' || ch==='\r')){
      if(ch==='\r' && text[i+1]==='\n') i++;
      row.push(field); field='';
      if(row.length>1 || (row.length===1 && row[0]!=='')) rows.push(row);
      row=[]; i++; continue;
    }
    if(!inQuotes && ch===delim){
      row.push(field); field=''; i++; continue;
    }
    field += ch; i++;
  }
  if(field.length || row.length){ row.push(field); rows.push(row); }
  return rows;
}
function normalizeHeaderName(h){
  return (h||'').toString().trim().toLowerCase();
}
function pickPlanQuantity(item, unit){
  const base = toNumber(item && item.kolicina);
  const m1 = toNumber(item && (item.m1 ?? item.m_1));
  const m2 = toNumber(item && (item.m2 ?? item.m_2));
  const m3 = toNumber(item && (item.m3 ?? item.m_3));
  const kom = toNumber(item && item.kom);
  switch(unit){
    case 'm1': return base || m1;
    case 'm2': return base || m2 || m1;
    case 'm3': return base || m3;
    case 'kom': return base || kom;
    default:
      if(m2) return m2;
      if(m1) return m1;
      if(kom) return kom;
      if(m3) return m3;
      return base;
  }
}
async function fetchPlanData(){
  const empty = { byRequest: new Map(), meta: new Map() };
  try{
    const res = await fetch('data/zahtevi.csv', {cache:'no-store'});
    if(!res.ok){ return empty; }
    const text = await res.text();
    const rows = parseCSVFlexible(text.trim());
    if(!rows.length){ return empty; }
    const header = rows[0].map(normalizeHeaderName);
    const idx = (name)=> header.indexOf(normalizeHeaderName(name));
    const iBroj = idx('broj')>=0 ? idx('broj') : 0;
    const iFirma = idx('firma');
    const iAdresa = idx('adresa');
    const iStavke = (idx('stavke_json')>=0) ? idx('stavke_json') : idx('stavke');
    const byRequest = new Map();
    const meta = new Map();
    for(let i=1;i<rows.length;i++){
      const cols = rows[i];
      if(!cols || !cols.length) continue;
      const broj = (cols[iBroj]||'').trim();
      if(!broj) continue;
      const normBroj = normalizeRequestNumber(broj);
      if(!normBroj) continue;
      const firma = iFirma>=0 ? (cols[iFirma]||'').trim() : '';
      const adresa = iAdresa>=0 ? (cols[iAdresa]||'').trim() : '';
      meta.set(normBroj, { broj, firma, adresa });
      const rawStavke = iStavke>=0 ? (cols[iStavke]||'').trim() : '';
      let stavke = [];
      if(rawStavke){
        let payload = rawStavke;
        try{ stavke = JSON.parse(payload); }
        catch(err){
          try{ stavke = JSON.parse(payload.replace(/""/g,'"')); }
          catch(_){ stavke = []; }
        }
      }
      if(!Array.isArray(stavke)) stavke = [];
      const artMap = byRequest.get(normBroj) || new Map();
      byRequest.set(normBroj, artMap);
      for(const s of stavke){
        if(!s) continue;
        const rawSifra = s.sifra ?? s.artikal ?? s.naziv ?? '';
        const sifra = (rawSifra||'').toString().trim();
        if(!sifra) continue;
        const artKey = normalizeArticleKey(sifra);
        if(!artKey) continue;
        const unit = canonicalUnit(s.jedinica);
        const qty = pickPlanQuantity(s, unit);
        const note = (s.napomena || s.napomena_artikla || '').toString().trim();
        const dimenzije = (s.dimenzije || '').toString().trim();
        const naziv = (s.naziv || '').toString().trim();
        let entry = artMap.get(artKey);
        if(!entry){
          entry = { sifra, jedinica: unit, plan: 0, notes: new Set(), dimenzije: '', naziv: '' };
          artMap.set(artKey, entry);
        }
        entry.plan += qty;
        if(!entry.dimenzije && dimenzije) entry.dimenzije = dimenzije;
        if(!entry.naziv && naziv) entry.naziv = naziv;
        if(note) entry.notes.add(note);
      }
    }
    return { byRequest, meta };
  }catch(err){
    console.warn('Greška pri čitanju planiranih zahteva', err);
    return empty;
  }
}
function selectProducedByUnit(totals, unit){
  if(!totals) return 0;
  if(unit && totals.hasOwnProperty(unit)) return totals[unit] ?? 0;
  return totals.m2 ?? totals.m1 ?? totals.kom ?? totals.m3 ?? 0;
}
function chooseUnitFromProduced(entry){
  if(!entry || !entry.totals) return 'm2';
  const totals = entry.totals;
  const order = ['m2','m1','kom','m3'];
  for(const u of order){
    if(Math.abs(totals[u]||0) > 0) return u;
  }
  return 'm2';
}
function buildNotes(planNotes, prodNotes){
  const parts = [];
  if(planNotes && planNotes.length) parts.push('Plan: '+planNotes.join('; '));
  if(prodNotes && prodNotes.length) parts.push('Proizvodnja: '+prodNotes.join('; '));
  return parts.join(' / ');
}
async function renderPregledCSV(){
  const rawTbody = document.querySelector('#tabela tbody');
  const summaryTbody = document.querySelector('#planTabela tbody');
  if(rawTbody) rawTbody.innerHTML='';
  if(summaryTbody) summaryTbody.innerHTML='';
  try{
    const [data, planData] = await Promise.all([fetchCSVAll(), fetchPlanData()]);
    const qZ = document.getElementById('filterZahtev')?.value || '';
    const qA = document.getElementById('filterArtikal')?.value || '';
    const qD = document.getElementById('filterDatum')?.value || '';
    const z = norm(qZ), a = norm(qA), d = (qD||'').trim();
    const filterNumber = normalizeRequestNumber(qZ);
    const hasZFilter = !!qZ.trim();

    const producedMap = new Map();
    data.forEach(row => {
      const brojNorm = normalizeRequestNumber(row.brojZahteva);
      const artKey = normalizeArticleKey(row.artikal);
      if(!brojNorm || !artKey) return;
      const key = brojNorm + KEY_SEP + artKey;
      let entry = producedMap.get(key);
      if(!entry){
        entry = {
          key,
          brojNorm,
          brojDisplay: row.brojZahteva || brojNorm,
          artikal: row.artikal || artKey,
          totals: {m1:0, m2:0, m3:0, kom:0},
          details: [],
          notes: new Set()
        };
        producedMap.set(key, entry);
      }
      const m1 = toNumber(row.m1);
      const m2 = toNumber(row.m2);
      const m3 = toNumber(row.m3);
      const kom = toNumber(row.kom);
      entry.totals.m1 += m1;
      entry.totals.m2 += m2;
      entry.totals.m3 += m3;
      entry.totals.kom += kom;
      entry.details.push({
        datum: row.datum || '',
        broj: row.brojZahteva || '',
        artikal: row.artikal || '',
        m1, m2, m3, kom,
        napomena: row.napomena || ''
      });
      if(row.napomena && row.napomena.trim()) entry.notes.add(row.napomena.trim());
      if(row.brojZahteva && row.brojZahteva.length > entry.brojDisplay.length) entry.brojDisplay = row.brojZahteva;
      if(row.artikal && row.artikal.length > entry.artikal.length) entry.artikal = row.artikal;
    });

    const planByRequest = planData.byRequest || new Map();
    const meta = planData.meta || new Map();
    const summaryRows = [];
    const summaryMap = new Map();
    const keys = new Set();
    producedMap.forEach((_, key)=> keys.add(key));
    planByRequest.forEach((artMap, brojNorm)=>{
      artMap.forEach((_, artKey)=>{ keys.add(brojNorm + KEY_SEP + artKey); });
    });

    keys.forEach(key => {
      const [brojNorm, artKey] = key.split(KEY_SEP);
      const planEntry = planByRequest.get(brojNorm)?.get(artKey) || null;
      const producedEntry = producedMap.get(key) || null;
      const brojDisplay = meta.get(brojNorm)?.broj || producedEntry?.brojDisplay || (planEntry ? meta.get(brojNorm)?.broj : brojNorm);
      const artDisplay = planEntry?.sifra || producedEntry?.artikal || artKey;
      const opisParts = [];
      if(planEntry?.dimenzije) opisParts.push(planEntry.dimenzije);
      if(planEntry?.naziv && planEntry.naziv !== planEntry.sifra) opisParts.push(planEntry.naziv);
      const opis = opisParts.join(' • ');
      const unit = planEntry ? planEntry.jedinica : chooseUnitFromProduced(producedEntry);
      const planQty = planEntry ? planEntry.plan : 0;
      const producedQty = producedEntry ? selectProducedByUnit(producedEntry.totals, unit) : 0;
      const planNotes = planEntry ? Array.from(planEntry.notes || []) : [];
      const prodNotes = producedEntry ? Array.from(producedEntry.notes || []) : [];
      const difference = planQty - producedQty;
      const details = producedEntry ? producedEntry.details.slice().sort((a,b)=>{
        const dateCmp = (a.datum||'').localeCompare(b.datum||'');
        if(dateCmp!==0) return dateCmp;
        return (a.artikal||'').localeCompare(b.artikal||'');
      }) : [];
      const row = {
        key,
        broj: brojDisplay || brojNorm,
        brojNorm,
        artikal: artDisplay,
        artikalKey: artKey,
        opis,
        unit,
        planQty,
        producedQty,
        difference,
        napomena: buildNotes(planNotes, prodNotes),
        planNotes,
        prodNotes,
        details,
        hasPlan: !!planEntry,
        hasProduction: !!producedEntry
      };
      summaryRows.push(row);
      summaryMap.set(key, row);
    });

    let displayRows = summaryRows.filter(row => {
      const brojMatch = !z || norm(row.broj).includes(z) || (!!filterNumber && row.brojNorm.includes(filterNumber));
      if(!brojMatch) return false;
      const artMatch = !a || norm(`${row.artikal||''} ${row.opis||''}`).includes(a);
      if(!artMatch) return false;
      const dateMatch = !d || (row.details && row.details.some(det => det.datum === d)) || (d && !row.details.length && hasZFilter && brojMatch);
      return dateMatch;
    });

    displayRows.sort((a,b)=>{
      const cmpBroj = a.brojNorm.localeCompare(b.brojNorm, undefined, {numeric:true, sensitivity:'base'});
      if(cmpBroj!==0) return cmpBroj;
      return a.artikal.localeCompare(b.artikal, undefined, {sensitivity:'base'});
    });

    if(summaryTbody){
      if(!displayRows.length){
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 7;
        td.className = 'muted';
        td.textContent = 'Nema podataka za prikaz.';
        tr.appendChild(td);
        summaryTbody.appendChild(tr);
      }else{
        displayRows.forEach(row => {
          const tr = document.createElement('tr');

          const tdBroj = document.createElement('td');
          tdBroj.textContent = row.broj || '';
          tr.appendChild(tdBroj);

          const tdArt = document.createElement('td');
          const artMain = document.createElement('div');
          const artStrong = document.createElement('b');
          artStrong.textContent = row.artikal || '';
          artMain.appendChild(artStrong);
          tdArt.appendChild(artMain);
          if(row.opis){
            const sub = document.createElement('div');
            sub.className = 'muted';
            sub.textContent = row.opis;
            tdArt.appendChild(sub);
          }
          tr.appendChild(tdArt);

          const tdPlan = document.createElement('td');
          tdPlan.className = 'right';
          tdPlan.textContent = formatQtyWithUnit(row.planQty, row.unit);
          tr.appendChild(tdPlan);

          const tdProd = document.createElement('td');
          tdProd.className = 'right';
          tdProd.textContent = formatQtyWithUnit(row.producedQty, row.unit);
          tr.appendChild(tdProd);

          const tdDiff = document.createElement('td');
          tdDiff.className = 'right';
          tdDiff.textContent = formatQtyWithUnit(row.difference, row.unit);
          if(row.difference > 0){ tdDiff.style.color = 'var(--warn)'; }
          else if(row.difference < 0){ tdDiff.style.color = 'var(--ok)'; }
          tr.appendChild(tdDiff);

          const tdNote = document.createElement('td');
          tdNote.textContent = row.napomena || '—';
          tr.appendChild(tdNote);

          const tdActions = document.createElement('td');
          tdActions.className = 'right nowrap';
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'secondary otvori';
          btn.style.width = 'auto';
          btn.textContent = 'Detalji';
          btn.dataset.summaryKey = row.key;
          tdActions.appendChild(btn);
          tr.appendChild(tdActions);

          summaryTbody.appendChild(tr);
        });
      }
    }

    if(rawTbody){
      const filteredRaw = data.filter(r => (!z || norm(r.brojZahteva).includes(z)) && (!a || norm(r.artikal).includes(a)) && (!d || r.datum===d));
      if(!filteredRaw.length){
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 9;
        td.className = 'muted';
        td.textContent = 'Nema zapisa za odabrani filter.';
        tr.appendChild(td);
        rawTbody.appendChild(tr);
      }else{
        filteredRaw.forEach(r => {
          const tr = document.createElement('tr');
          const cells = [
            r.datum||'',
            r.brojZahteva||'',
            r.artikal||'',
            fmt(r.m1)||'',
            fmt(r.m2)||'',
            fmt(r.m3)||'',
            fmt(r.kom)||'',
            r.napomena||''
          ];
          cells.forEach((val, idx) => {
            const td = document.createElement('td');
            if(idx>=3 && idx<=6) td.className = 'right';
            td.textContent = val;
            tr.appendChild(td);
          });
          const act = document.createElement('td');
          act.className = 'right nowrap';
          const edit = document.createElement('button');
          edit.className = 'ok edit-btn';
          edit.type = 'button';
          edit.style.width = 'auto';
          edit.textContent = 'Izmeni';
          act.appendChild(edit);
          tr.appendChild(act);
          rawTbody.appendChild(tr);
        });
      }
    }

    window.__PLAN_REAL_SUMMARY = summaryRows;
    window.__PLAN_REAL_MAP = summaryMap;
    return displayRows;
  }catch(err){
    console.error('Neuspešno generisanje pregleda', err);
    if(summaryTbody){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 7;
      td.className = 'muted';
      td.textContent = 'Greška pri učitavanju pregleda.';
      tr.appendChild(td);
      summaryTbody.appendChild(tr);
    }
    return [];
  }
}
function onPregledRendered(rows, opts={}){
  try{
    const list = Array.isArray(rows) ? rows : [];
    const info = document.getElementById('planSummaryInfo');
    if(info){
      info.textContent = list.length ? `Prikazano ${list.length} stavki` : 'Nema podataka za prikaz';
    }
    if(opts.focus){
      const card = document.getElementById('planSummaryCard');
      if(card){
        card.classList.remove('flash-card');
        void card.offsetWidth;
        card.classList.add('flash-card');
        card.scrollIntoView({behavior:'smooth', block:'start'});
        setTimeout(()=>card.classList.remove('flash-card'), 1200);
      }
    }
  }catch(err){
    console.warn('Pregled UI update problem', err);
  }
}
function refreshPlanPregled(opts={}){
  const result = renderPregledCSV();
  if(result && typeof result.then === 'function'){
    return result.then(rows => { onPregledRendered(rows, opts); return rows; });
  }
  onPregledRendered(result, opts);
  return Promise.resolve(result);
}
['input','change'].forEach(evt=>{
  const handler = ()=>{ refreshPlanPregled(); };
  document.getElementById('filterZahtev')?.addEventListener(evt, handler);
  document.getElementById('filterArtikal')?.addEventListener(evt, handler);
  document.getElementById('filterDatum')?.addEventListener(evt, handler);
});

function openSummaryDetail(summary){
  if(!summary){
    alert('Detalji nisu dostupni.');
    return;
  }
  const chip = document.getElementById('detChip');
  if(chip) chip.textContent = `${summary.broj||''} • ${summary.artikal||''}`;
  const planEl = document.getElementById('detPlan');
  if(planEl) planEl.textContent = formatQtyWithUnit(summary.planQty, summary.unit);
  const planLbl = document.getElementById('detPlanLabel');
  if(planLbl) planLbl.textContent = summary.hasPlan ? 'Planirane količine' : 'Plan nije definisan';
  const prodEl = document.getElementById('detProizvedeno');
  if(prodEl) prodEl.textContent = formatQtyWithUnit(summary.producedQty, summary.unit);
  const prodLbl = document.getElementById('detProizvedenoLabel');
  if(prodLbl) prodLbl.textContent = summary.hasProduction ? 'Zabeležena proizvodnja' : 'Još nema proizvodnje';
  const diffEl = document.getElementById('detRazlika');
  if(diffEl){
    diffEl.textContent = formatQtyWithUnit(summary.difference, summary.unit);
    diffEl.style.color = summary.difference > 0 ? 'var(--warn)' : (summary.difference < 0 ? 'var(--ok)' : 'var(--ink)');
  }
  const diffLbl = document.getElementById('detRazlikaLabel');
  if(diffLbl) diffLbl.textContent = 'Plan – proizvodnja';
  const nap = document.getElementById('detNapomena');
  if(nap) nap.textContent = summary.napomena || 'Bez dodatnih napomena.';
  const tb = document.querySelector('#detPregled tbody');
  if(tb){
    tb.innerHTML='';
    if(summary.details && summary.details.length){
      summary.details.forEach(det => {
        const tr = document.createElement('tr');
        const values = [
          det.datum || '',
          det.broj || summary.broj || '',
          det.artikal || summary.artikal || '',
          formatQty(det.m1, 'm1'),
          formatQty(det.m2, 'm2'),
          formatQty(det.m3, 'm3'),
          formatQty(det.kom, 'kom'),
          det.napomena || ''
        ];
        values.forEach((val, idx)=>{
          const td = document.createElement('td');
          if(idx>=3 && idx<=6) td.className = 'right';
          td.textContent = val;
          tr.appendChild(td);
        });
        const act = document.createElement('td');
        act.className = 'right nowrap';
        const edit = document.createElement('button');
        edit.type = 'button';
        edit.className = 'ok edit-btn';
        edit.style.width = 'auto';
        edit.textContent = 'Izmeni';
        act.appendChild(edit);
        tr.appendChild(act);
        tb.appendChild(tr);
      });
    }else{
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 9;
      td.className = 'muted';
      td.textContent = 'Nema evidentiranih proizvodnih zapisa.';
      tr.appendChild(td);
      tb.appendChild(tr);
    }
  }
  const back = document.getElementById('modalBackPregled');
  if(back) back.style.display='flex';
}

// Open modal with aggregated details
document.addEventListener('click', e => {
  const btn = e.target.closest && e.target.closest('button.otvori');
  if(!btn) return;
  const key = btn.dataset.summaryKey;
  if(key && window.__PLAN_REAL_MAP){
    const summary = window.__PLAN_REAL_MAP.get(key);
    openSummaryDetail(summary);
  }
});
document.getElementById('closePregled')?.addEventListener('click', ()=>{
  const back = document.getElementById('modalBackPregled'); if(back) back.style.display='none';
});
document.getElementById('modalBackPregled')?.addEventListener('click', e=>{
  if(e.target && e.target.id==='modalBackPregled') e.currentTarget.style.display='none';
});
</script>
<script>
/* === STARFIELD === */
    const c = document.getElementById('stars'); const x = c.getContext('2d');
    function resize(){ c.width = innerWidth; c.height = innerHeight; }
    addEventListener('resize', resize); resize();
    const N=200, stars=[];
    for(let i=0;i<N;i++){ stars.push({x:Math.random()*c.width, y:Math.random()*c.height, z:Math.random()*2+0.5, r:Math.random()*1.6+0.2}); }
    let mx=0,my=0; addEventListener('pointermove', e=>{ mx = (e.clientX/innerWidth - .5); my = (e.clientY/innerHeight - .5); });
    function draw(){
      x.clearRect(0,0,c.width,c.height);
      for(const s of stars){
        s.x += (s.z*0.15) + mx*0.6; if(s.x>c.width+10) s.x=-10;
        s.y += my*0.4; if(s.y<-10) s.y=c.height+10; if(s.y>c.height+10) s.y=-10;
        x.beginPath(); x.arc(s.x,s.y,s.r,0,Math.PI*2);
        const g = x.createRadialGradient(s.x,s.y,0,s.x,s.y,s.r*3);
        g.addColorStop(0,'rgba(124,58,237,.9)'); g.addColorStop(1,'rgba(124,58,237,0)');
        x.fillStyle = g; x.fill();
      }
      requestAnimationFrame(draw);
    } draw();

    
</script>

<!-- EDIT MODAL (Proizvodnja) -->
<div class="modal-back" id="modalBackProd" style="display:none">
  <div class="modal">
    <div class="row" style="justify-content:space-between">
      <div class="row" style="gap:8px">
        <span class="pill">Izmena izveštaja</span>
        <span class="chip"><b id="chipKeyProd"></b></span>
      </div>
      <div class="row" style="gap:8px">
        <button class="secondary" id="cancelEditProd" type="button" style="width:auto">Otkaži</button>
        <button class="ok" id="saveEditProd" type="button" style="width:auto">Sačuvaj izmene</button>
      </div>
    </div>
    <div class="deck" style="margin-top:8px">
      <div class="col-4"><label>Datum</label><input id="editDatum"/></div>
      <div class="col-4"><label>Broj zahteva</label><input id="editBroj"/></div>
      <div class="col-4"><label>Artikal</label><div class="ac2-wrap"><input id="editArtikal"/><div class="ac2-menu"></div></div></div>
      <div class="col-3"><label>M¹</label><input id="editM1" type="number" step="any"/></div>
      <div class="col-3"><label>M²</label><input id="editM2" type="number" step="any"/></div>
      <div class="col-3"><label>M³</label><input id="editM3" type="number" step="any"/></div>
      <div class="col-3"><label>Kom</label><input id="editKom" type="number" step="any"/></div>
      <div class="col-12"><label>Napomena</label><input id="editNapomena"/></div>
    </div>
  </div>
</div>


<script>
(function(){
  function txt(tr,i){ const td=tr&&tr.children&&tr.children[i]; return (td?td.textContent:'').trim(); }

  document.addEventListener('click', function(e){
    let btn = e.target && e.target.closest && e.target.closest('button.edit-btn');
    if(!btn){
      const alt = e.target.closest && e.target.closest('button.ok');
      if(alt && /izmeni/i.test(alt.textContent||'')) btn = alt;
    }
    if(!btn) return;
    const tr = btn.closest('tr'); if(!tr) return;
    const d = txt(tr,0), b = txt(tr,1), a = txt(tr,2), m1 = txt(tr,3), m2 = txt(tr,4), m3 = txt(tr,5), kom = txt(tr,6), nap = txt(tr,7) || '';
    const back = document.getElementById('modalBackProd'); if(!back) return;
    const chip = document.getElementById('chipKeyProd'); if(chip) chip.textContent = d+' • '+b+' • '+a;
    const set = (id,val)=>{ const el=document.getElementById(id); if(el) el.value=val; };
    set('editDatum', d); set('editBroj', b); set('editArtikal', a); set('editM1', m1); set('editM2', m2); set('editM3', m3); set('editKom', kom); set('editNapomena', nap);
    back.style.display = 'flex';
  }, true);

  // Zatvaranje
  document.getElementById('cancelEditProd')?.addEventListener('click', function(){
    const back = document.getElementById('modalBackProd'); if(back) back.style.display='none';
  });
  document.getElementById('modalBackProd')?.addEventListener('click', function(e){
    if(e.target && e.target.id==='modalBackProd'){ e.currentTarget.style.display='none'; }
  });
})();
</script>


<script>
(function(){
  function cellTxt(tr,i){ const td=tr&&tr.children&&tr.children[i]; return (td?td.textContent:'').trim(); }
  async function postForm(url, data){
    const body = new URLSearchParams();
    for(const [k,v] of Object.entries(data)) body.append(k, String(v ?? ''));
    const res = await fetch(url, { method:'POST', body });
    const text = await res.text();
    return {ok: res.ok && /^OK/.test(text), status: res.status, text};
  }

  // Ensure original key is stored when opening Edit
  document.addEventListener('click', function(e){
    const btn = e.target && e.target.closest && e.target.closest('button.edit-btn');
    if(!btn) return;
    const tr = btn.closest('tr'); if(!tr) return;
    const save = document.getElementById('saveEditProd'); if(!save) return;
    save.dataset.odatum = cellTxt(tr,0);
    save.dataset.obroj  = cellTxt(tr,1);
    save.dataset.oart   = cellTxt(tr,2);
  }, true);

  // SAVE handler
  const saveBtn = document.getElementById('saveEditProd');
  if (saveBtn && !saveBtn._wired){
    saveBtn._wired = true;
    saveBtn.addEventListener('click', async function(){
      const sb = this;
      const payload = {
        action:'update',
        datum:       (document.getElementById('editDatum')||{}).value?.trim() || '',
        brojZahteva: (document.getElementById('editBroj')||{}).value?.trim() || '',
        artikal:     (document.getElementById('editArtikal')||{}).value?.trim() || '',
        m1:          (document.getElementById('editM1')||{}).value?.trim() || '',
        m2:          (document.getElementById('editM2')||{}).value?.trim() || '',
        m3:          (document.getElementById('editM3')||{}).value?.trim() || '',
        kom:         (document.getElementById('editKom')||{}).value?.trim() || '',
        napomena:    (document.getElementById('editNapomena')||{}).value?.trim() || '',
        o_datum:       sb.dataset.odatum || '',
        o_brojZahteva: sb.dataset.obroj  || '',
        o_artikal:     sb.dataset.oart   || ''
      };
      if(!payload.datum || !payload.brojZahteva || !payload.artikal){
        alert('Obavezno: Datum, Broj zahteva, Artikal'); return;
      }
      const r = await postForm('../save_izvestaj.php', payload);
      if(!r.ok){
        alert('Greška pri čuvanju (HTTP '+r.status+'):\n'+r.text);
        return;
      }
      // Close modal
      const back = document.getElementById('modalBackProd'); if(back) back.style.display='none';

      // Optimistic UI update: replace row matching original key
      const rows = document.querySelectorAll('#tabela tbody tr');
      for (const tr of rows){
        const d0 = cellTxt(tr,0), b0 = cellTxt(tr,1), a0 = cellTxt(tr,2);
        if (d0===sb.dataset.odatum && b0===sb.dataset.obroj && a0===sb.dataset.oart){
          if(tr.children[0]) tr.children[0].textContent = payload.datum;
          if(tr.children[1]) tr.children[1].textContent = payload.brojZahteva;
          if(tr.children[2]) tr.children[2].textContent = payload.artikal;
          if(tr.children[3]) tr.children[3].textContent = payload.m1;
          if(tr.children[4]) tr.children[4].textContent = payload.m2;
          if(tr.children[5]) tr.children[5].textContent = payload.m3;
          if(tr.children[6]) tr.children[6].textContent = payload.kom;
          if(tr.children[7]) tr.children[7].textContent = payload.napomena;
          break;
        }
      }
      // Full refresh if available
      try{
        if(typeof refreshPlanPregled === 'function'){
          const focus = !document.getElementById('sekcija-pregled')?.classList.contains('hidden');
          await refreshPlanPregled({focus});
        }else if(typeof renderPregledCSV === 'function'){
          const ref = renderPregledCSV();
          if (ref && typeof ref.then === 'function') await ref;
        }
      }catch(_){}
    });
  }
})();
</script>

</body>
</html>
